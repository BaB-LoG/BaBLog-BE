<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.bablog.report.repository.mapper.WeeklyReportMapper">

    <resultMap id="WeeklyReportResultMap" type="com.ssafy.bablog.report.domain.WeeklyReport">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="aiScore" column="ai_score"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="grade" column="grade"/>
        <result property="summary" column="summary"/>
        <result property="patternSummary" column="pattern_summary"/>
        <result property="bestDay" column="best_day"/>
        <result property="bestReason" column="best_reason"/>
        <result property="worstDay" column="worst_day"/>
        <result property="worstReason" column="worst_reason"/>
        <result property="nextWeekFocus" column="next_week_focus"/>
        <result property="highlights" column="highlights"/>
        <result property="improvements" column="improvements"/>
        <result property="recommendations" column="recommendations"/>
        <result property="trend" column="trend"/>
        <result property="riskFlags" column="risk_flags"/>
        <result property="consistencyScore" column="consistency_score"/>
        <result property="reportVersion" column="report_version"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="upsert" parameterType="com.ssafy.bablog.report.domain.WeeklyReport">
        INSERT INTO weekly_report (
            member_id, ai_score, start_date, end_date, grade,
            summary, pattern_summary, best_day, best_reason, worst_day, worst_reason,
            next_week_focus, highlights, improvements, recommendations,
            trend, risk_flags, consistency_score, report_version
        )
        VALUES (
            #{memberId}, #{aiScore}, #{startDate}, #{endDate}, #{grade},
            #{summary}, #{patternSummary}, #{bestDay}, #{bestReason}, #{worstDay}, #{worstReason},
            #{nextWeekFocus}, #{highlights}, #{improvements}, #{recommendations},
            #{trend}, #{riskFlags}, #{consistencyScore}, #{reportVersion}
        )
        ON DUPLICATE KEY UPDATE
            ai_score = VALUES(ai_score),
            grade = VALUES(grade),
            summary = VALUES(summary),
            pattern_summary = VALUES(pattern_summary),
            best_day = VALUES(best_day),
            best_reason = VALUES(best_reason),
            worst_day = VALUES(worst_day),
            worst_reason = VALUES(worst_reason),
            next_week_focus = VALUES(next_week_focus),
            highlights = VALUES(highlights),
            improvements = VALUES(improvements),
            recommendations = VALUES(recommendations),
            trend = VALUES(trend),
            risk_flags = VALUES(risk_flags),
            consistency_score = VALUES(consistency_score),
            report_version = VALUES(report_version),
            updated_at = CURRENT_TIMESTAMP
    </insert>

    <select id="findByMemberAndRange" resultMap="WeeklyReportResultMap">
        SELECT id, member_id, ai_score, start_date, end_date, grade,
               summary, pattern_summary, best_day, best_reason, worst_day, worst_reason,
               next_week_focus, highlights, improvements, recommendations,
               trend, risk_flags, consistency_score, report_version,
               created_at, updated_at
        FROM weekly_report
        WHERE member_id = #{memberId}
          AND start_date = #{startDate}
          AND end_date = #{endDate}
        LIMIT 1
    </select>

</mapper>
