<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.bablog.meal.repository.mapper.MealMapper">

    <resultMap id="MealResultMap" type="com.ssafy.bablog.meal.domain.Meal">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="mealType" column="meal_type"/>
        <result property="mealDate" column="meal_date"/>
        <result property="kcal" column="kcal"/>
        <result property="protein" column="protein"/>
        <result property="fat" column="fat"/>
        <result property="saturatedFat" column="saturated_fat"/>
        <result property="transFat" column="trans_fat"/>
        <result property="carbohydrates" column="carbohydrates"/>
        <result property="sugar" column="sugar"/>
        <result property="natrium" column="natrium"/>
        <result property="cholesterol" column="cholesterol"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.ssafy.bablog.meal.domain.Meal" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO meal (member_id, meal_type, meal_date)
        VALUES (#{memberId}, #{mealType}, #{mealDate})
    </insert>

    <select id="findById" parameterType="long" resultMap="MealResultMap">
        SELECT id, member_id, meal_type, meal_date,
               kcal, protein, fat, saturated_fat, trans_fat, carbohydrates, sugar, natrium, cholesterol,
               created_at, updated_at
        FROM meal
        WHERE id = #{id}
    </select>

    <select id="findByMemberAndDate" resultMap="MealResultMap">
        SELECT id, member_id, meal_type, meal_date,
               kcal, protein, fat, saturated_fat, trans_fat, carbohydrates, sugar, natrium, cholesterol,
               created_at, updated_at
        FROM meal
        WHERE member_id = #{memberId}
          AND meal_date = #{mealDate}
        ORDER BY meal_type
    </select>

    <select id="findByMemberAndTypeAndDate" resultMap="MealResultMap">
        SELECT id, member_id, meal_type, meal_date,
               kcal, protein, fat, saturated_fat, trans_fat, carbohydrates, sugar, natrium, cholesterol,
               created_at, updated_at
        FROM meal
        WHERE member_id = #{memberId}
          AND meal_type = #{mealType}
          AND meal_date = #{mealDate}
    </select>

    <update id="adjustNutrition">
        UPDATE meal
        SET kcal = GREATEST(COALESCE(kcal, 0) + IFNULL(#{delta.kcal}, 0), 0),
            protein = GREATEST(COALESCE(protein, 0) + IFNULL(#{delta.protein}, 0), 0),
            fat = GREATEST(COALESCE(fat, 0) + IFNULL(#{delta.fat}, 0), 0),
            saturated_fat = GREATEST(COALESCE(saturated_fat, 0) + IFNULL(#{delta.saturatedFat}, 0), 0),
            trans_fat = GREATEST(COALESCE(trans_fat, 0) + IFNULL(#{delta.transFat}, 0), 0),
            carbohydrates = GREATEST(COALESCE(carbohydrates, 0) + IFNULL(#{delta.carbohydrates}, 0), 0),
            sugar = GREATEST(COALESCE(sugar, 0) + IFNULL(#{delta.sugar}, 0), 0),
            natrium = GREATEST(COALESCE(natrium, 0) + IFNULL(#{delta.natrium}, 0), 0),
            cholesterol = GREATEST(COALESCE(cholesterol, 0) + IFNULL(#{delta.cholesterol}, 0), 0),
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

</mapper>
