<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.bablog.meal_log.repository.mapper.MealLogMapper">

    <resultMap id="MealLogResultMap" type="com.ssafy.bablog.meal_log.domain.MealLog">
        <id property="id" column="id"/>
        <result property="mealId" column="meal_id"/>
        <result property="memberId" column="member_id"/>
        <result property="loggedAt" column="logged_at"/>
        <result property="kcal" column="kcal"/>
        <result property="protein" column="protein"/>
        <result property="fat" column="fat"/>
        <result property="saturatedFat" column="saturated_fat"/>
        <result property="transFat" column="trans_fat"/>
        <result property="carbohydrates" column="carbohydrates"/>
        <result property="sugar" column="sugar"/>
        <result property="natrium" column="natrium"/>
        <result property="cholesterol" column="cholesterol"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="upsert" parameterType="com.ssafy.bablog.meal_log.domain.MealLog">
        INSERT INTO meal_log (
            meal_id, member_id, logged_at,
            kcal, protein, fat, saturated_fat, trans_fat,
            carbohydrates, sugar, natrium, cholesterol
        )
        VALUES (
            #{mealId}, #{memberId}, #{loggedAt},
            #{kcal}, #{protein}, #{fat}, #{saturatedFat}, #{transFat},
            #{carbohydrates}, #{sugar}, #{natrium}, #{cholesterol}
        )
        ON DUPLICATE KEY UPDATE
            member_id = VALUES(member_id),
            logged_at = VALUES(logged_at),
            kcal = GREATEST(COALESCE(meal_log.kcal, 0) + IFNULL(VALUES(kcal), 0), 0),
            protein = GREATEST(COALESCE(meal_log.protein, 0) + IFNULL(VALUES(protein), 0), 0),
            fat = GREATEST(COALESCE(meal_log.fat, 0) + IFNULL(VALUES(fat), 0), 0),
            saturated_fat = GREATEST(COALESCE(meal_log.saturated_fat, 0) + IFNULL(VALUES(saturated_fat), 0), 0),
            trans_fat = GREATEST(COALESCE(meal_log.trans_fat, 0) + IFNULL(VALUES(trans_fat), 0), 0),
            carbohydrates = GREATEST(COALESCE(meal_log.carbohydrates, 0) + IFNULL(VALUES(carbohydrates), 0), 0),
            sugar = GREATEST(COALESCE(meal_log.sugar, 0) + IFNULL(VALUES(sugar), 0), 0),
            natrium = GREATEST(COALESCE(meal_log.natrium, 0) + IFNULL(VALUES(natrium), 0), 0),
            cholesterol = GREATEST(COALESCE(meal_log.cholesterol, 0) + IFNULL(VALUES(cholesterol), 0), 0),
            updated_at = CURRENT_TIMESTAMP
    </insert>

    <select id="findByMealIds" resultMap="MealLogResultMap">
        SELECT id, meal_id, member_id, logged_at,
               kcal, protein, fat, saturated_fat, trans_fat,
               carbohydrates, sugar, natrium, cholesterol,
               created_at, updated_at
        FROM meal_log
        WHERE meal_id IN
        <foreach collection="list" item="mealId" open="(" separator="," close=")">
            #{mealId}
        </foreach>
    </select>

</mapper>
